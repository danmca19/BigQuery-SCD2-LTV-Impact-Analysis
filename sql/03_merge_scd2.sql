MERGE `scd2-ltv-analysis.tracking_risco_cliente.dim_customers` T USING (SELECT customer_id, name, risk_segment, TO_HEX(SHA256(CONCAT(COALESCE(UPPER(risk_segment),''),'||',COALESCE(name,''),'||',COALESCE(customer_id,'')))) AS record_hash, load_ts FROM `scd2-ltv-analysis.tracking_risco_cliente.customers_staging`) S ON T.customer_id=S.customer_id AND T.is_current=TRUE WHEN MATCHED AND T.record_hash<>S.record_hash THEN UPDATE SET valid_to=CURRENT_DATE(), is_current=FALSE WHEN NOT MATCHED BY TARGET THEN INSERT (customer_id,name,risk_segment,record_hash,valid_from,valid_to,is_current,source_load_ts) VALUES (S.customer_id,S.name,S.risk_segment,S.record_hash,CURRENT_DATE(),NULL,TRUE,S.load_ts);