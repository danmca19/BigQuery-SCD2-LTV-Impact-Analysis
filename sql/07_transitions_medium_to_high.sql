WITH seq AS ( SELECT customer_id, ARRAY_AGG(risk_segment ORDER BY valid_from) AS seg_seq FROM `scd2-ltv-analysis.tracking_risco_cliente.dim_customers` GROUP BY customer_id ) SELECT COUNT(1) AS num_medium_to_high FROM ( SELECT customer_id FROM seq WHERE EXISTS (SELECT 1 FROM UNNEST(seg_seq) WITH OFFSET AS pos WHERE pos < ARRAY_LENGTH(seg_seq)-1 AND seg_seq[OFFSET(pos)]='MEDIUM' AND seg_seq[OFFSET(pos+1)]='HIGH') );