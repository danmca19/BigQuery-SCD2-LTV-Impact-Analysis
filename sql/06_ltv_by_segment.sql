WITH customer_ltv AS ( SELECT t.customer_id, d.risk_segment, SUM(t.amount) AS lifetime_value FROM `scd2-ltv-analysis.tracking_risco_cliente.fact_transactions` t JOIN `scd2-ltv-analysis.tracking_risco_cliente.dim_customers` d ON t.customer_id=d.customer_id AND t.transaction_date BETWEEN d.valid_from AND COALESCE(d.valid_to,CURRENT_DATE()) GROUP BY t.customer_id, d.risk_segment ) SELECT risk_segment, COUNT(DISTINCT customer_id) AS num_customers, ROUND(AVG(lifetime_value),2) AS avg_ltv, ROUND(SUM(lifetime_value),2) AS total_revenue FROM customer_ltv GROUP BY risk_segment ORDER BY avg_ltv DESC;